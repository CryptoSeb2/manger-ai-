{% extends "base.html" %}
{% block title %}Billing - WorkWithAi{% endblock %}

{% block body %}
<div class="flex h-full min-h-screen" x-data="billingApp()">
    {% include "nav.html" %}

    <main class="flex-1 overflow-y-auto">
        <div class="px-8 py-8 max-w-4xl">

            <div class="mb-8">
                <h1 class="text-2xl font-bold text-gray-900">Billing &amp; Plan</h1>
                <p class="mt-1 text-sm text-gray-500">Manage your subscription, view usage, and update payment details.</p>
            </div>

            <!-- Payment Required Banner -->
            {% if billing_status == 'pending' %}
            <div class="mb-6 rounded-xl border border-amber-200 bg-amber-50 p-5">
                <div class="flex items-start gap-3">
                    <svg class="h-5 w-5 text-amber-600 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                    <div>
                        <p class="text-sm font-semibold text-amber-800">Payment required</p>
                        <p class="mt-1 text-sm text-amber-700">Your account is set up but no payment method is on file. Choose a plan below to activate your AI phone agent.</p>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if billing_status == 'past_due' %}
            <div class="mb-6 rounded-xl border border-red-200 bg-red-50 p-5">
                <div class="flex items-start gap-3">
                    <svg class="h-5 w-5 text-red-600 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                    <div>
                        <p class="text-sm font-semibold text-red-800">Payment past due</p>
                        <p class="mt-1 text-sm text-red-700">Your last payment failed. Please update your payment method to keep your AI agent active.</p>
                        <button @click="openPortal()" class="mt-3 rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white hover:bg-red-700 transition">
                            Update Payment Method
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Current Plan -->
            <div class="mb-8 rounded-xl border border-gray-200 bg-white overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                    <h2 class="text-base font-semibold text-gray-900">Current Plan</h2>
                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold
                        {% if billing_status == 'active' %}bg-green-50 text-green-700 ring-1 ring-green-600/20
                        {% elif billing_status == 'past_due' %}bg-red-50 text-red-700 ring-1 ring-red-600/20
                        {% elif billing_status == 'pending' %}bg-amber-50 text-amber-700 ring-1 ring-amber-600/20
                        {% else %}bg-gray-100 text-gray-600 ring-1 ring-gray-500/20{% endif %}">
                        {{ billing_status|capitalize }}
                    </span>
                </div>
                <div class="px-6 py-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Plan</p>
                            <p class="mt-1 text-2xl font-bold text-gray-900">{{ plan_name }}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Monthly Price</p>
                            <p class="mt-1 text-2xl font-bold text-gray-900">{{ plan_price }}</p>
                        </div>
                    </div>
                    <div class="mt-6 grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div class="rounded-lg bg-gray-50 p-4 text-center">
                            <p class="text-2xl font-bold text-gray-900">{{ total_calls }}</p>
                            <p class="mt-1 text-xs text-gray-500">Calls This Month</p>
                        </div>
                        <div class="rounded-lg bg-gray-50 p-4 text-center">
                            <p class="text-2xl font-bold text-gray-900">{{ call_limit }}</p>
                            <p class="mt-1 text-xs text-gray-500">Call Limit</p>
                        </div>
                        <div class="rounded-lg bg-gray-50 p-4 text-center">
                            <p class="text-2xl font-bold text-gray-900">{{ total_appointments }}</p>
                            <p class="mt-1 text-xs text-gray-500">Appointments Booked</p>
                        </div>
                        <div class="rounded-lg bg-gray-50 p-4 text-center">
                            <p class="text-2xl font-bold text-gray-900">{{ phone_numbers }}</p>
                            <p class="mt-1 text-xs text-gray-500">Phone Numbers</p>
                        </div>
                    </div>
                    {% if plan == 'pro' and total_calls >= 400 %}
                    <div class="mt-4 rounded-lg bg-amber-50 border border-amber-200 p-3">
                        <p class="text-sm text-amber-800">You're approaching your 500 call limit. Consider upgrading to Enterprise for unlimited calls.</p>
                    </div>
                    {% endif %}

                    {% if billing_status == 'active' %}
                    <div class="mt-6 flex gap-3">
                        <button @click="openPortal()"
                            class="rounded-lg bg-white px-4 py-2 text-sm font-semibold text-gray-700 ring-1 ring-gray-200 hover:bg-gray-50 transition">
                            Manage Subscription
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Plan Comparison / Subscribe -->
            <div class="mb-8 rounded-xl border border-gray-200 bg-white overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100">
                    <h2 class="text-base font-semibold text-gray-900">
                        {% if billing_status == 'pending' %}Choose Your Plan{% else %}Plan Comparison{% endif %}
                    </h2>
                </div>
                <div class="p-6">
                    {% if billing_status not in ['active'] %}
                    <p class="text-sm text-gray-500 mb-2">All plans include a one-time <strong class="text-gray-900">$3,000</strong> setup fee covering custom AI configuration, dedicated phone number, calendar integration, and onboarding.</p>
                    <hr class="my-5 border-gray-100">
                    {% endif %}

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Pro Card -->
                        <div class="rounded-xl border {{ 'border-brand-300 ring-2 ring-brand-100' if plan == 'pro' and billing_status == 'active' else 'border-gray-200' }} p-6 flex flex-col relative">
                            {% if plan == 'pro' and billing_status == 'active' %}
                            <div class="absolute -top-2.5 left-4 rounded-md bg-brand-600 px-2 py-0.5 text-[10px] font-bold text-white uppercase tracking-wider">Current</div>
                            {% endif %}
                            <p class="text-lg font-bold text-gray-900">Pro</p>
                            <div class="mt-2 flex items-baseline gap-1">
                                <span class="text-3xl font-extrabold text-gray-900">$499</span>
                                <span class="text-sm text-gray-400">/month</span>
                            </div>
                            <p class="mt-1 text-sm text-gray-500">500 calls per month</p>
                            <ul class="mt-5 space-y-2.5 flex-1">
                                <li class="flex items-start gap-2 text-sm text-gray-600"><svg class="mt-0.5 h-4 w-4 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>AI phone agent 24/7</li>
                                <li class="flex items-start gap-2 text-sm text-gray-600"><svg class="mt-0.5 h-4 w-4 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Appointment booking</li>
                                <li class="flex items-start gap-2 text-sm text-gray-600"><svg class="mt-0.5 h-4 w-4 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Google Calendar integration</li>
                                <li class="flex items-start gap-2 text-sm text-gray-600"><svg class="mt-0.5 h-4 w-4 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Transcripts &amp; summaries</li>
                                <li class="flex items-start gap-2 text-sm text-gray-600"><svg class="mt-0.5 h-4 w-4 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Sentiment analysis</li>
                                <li class="flex items-start gap-2 text-sm text-gray-600"><svg class="mt-0.5 h-4 w-4 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>1 dedicated phone number</li>
                                <li class="flex items-start gap-2 text-sm text-gray-600"><svg class="mt-0.5 h-4 w-4 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Full dashboard access</li>
                            </ul>
                            {% if billing_status != 'active' or plan != 'pro' %}
                            <button @click="subscribe('pro')" :disabled="loading"
                                class="mt-6 w-full rounded-lg ring-1 ring-gray-200 py-2.5 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition disabled:opacity-50">
                                <span x-show="!loading || selectedPlan !== 'pro'">{{ 'Subscribe to Pro' if billing_status != 'active' else 'Switch to Pro' }}</span>
                                <span x-show="loading && selectedPlan === 'pro'" x-cloak>Redirecting to Stripe...</span>
                            </button>
                            {% endif %}
                        </div>

                        <!-- Enterprise Card -->
                        <div class="rounded-xl border {{ 'border-brand-300 ring-2 ring-brand-100' if plan == 'enterprise' and billing_status == 'active' else 'border-gray-200' }} p-6 flex flex-col relative">
                            {% if plan == 'enterprise' and billing_status == 'active' %}
                            <div class="absolute -top-2.5 left-4 rounded-md bg-brand-600 px-2 py-0.5 text-[10px] font-bold text-white uppercase tracking-wider">Current</div>
                            {% elif plan != 'enterprise' or billing_status != 'active' %}
                            <div class="absolute -top-2.5 right-4 rounded-md bg-gray-900 px-2 py-0.5 text-[10px] font-bold text-white uppercase tracking-wider">Recommended</div>
                            {% endif %}
                            <p class="text-lg font-bold text-gray-900">Enterprise</p>
                            <div class="mt-2 flex items-baseline gap-1">
                                <span class="text-3xl font-extrabold text-gray-900">$699</span>
                                <span class="text-sm text-gray-400">/month</span>
                            </div>
                            <p class="mt-1 text-sm text-gray-500">Unlimited calls</p>
                            <ul class="mt-5 space-y-2.5 flex-1">
                                <li class="flex items-start gap-2 text-sm text-gray-600"><svg class="mt-0.5 h-4 w-4 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Everything in Pro</li>
                                <li class="flex items-start gap-2 text-sm text-gray-600"><svg class="mt-0.5 h-4 w-4 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg><strong>Unlimited</strong> calls per month</li>
                                <li class="flex items-start gap-2 text-sm text-gray-600"><svg class="mt-0.5 h-4 w-4 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Up to <strong>3</strong> phone numbers</li>
                                <li class="flex items-start gap-2 text-sm text-gray-600"><svg class="mt-0.5 h-4 w-4 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Custom AI voice selection</li>
                                <li class="flex items-start gap-2 text-sm text-gray-600"><svg class="mt-0.5 h-4 w-4 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Priority support</li>
                                <li class="flex items-start gap-2 text-sm text-gray-600"><svg class="mt-0.5 h-4 w-4 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Email notifications</li>
                            </ul>
                            {% if billing_status != 'active' or plan != 'enterprise' %}
                            <button @click="subscribe('enterprise')" :disabled="loading"
                                class="mt-6 w-full rounded-lg bg-brand-600 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-brand-700 transition disabled:opacity-50">
                                <span x-show="!loading || selectedPlan !== 'enterprise'">{{ 'Subscribe to Enterprise' if billing_status != 'active' else 'Upgrade to Enterprise' }}</span>
                                <span x-show="loading && selectedPlan === 'enterprise'" x-cloak>Redirecting to Stripe...</span>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Billing Details -->
            <div class="rounded-xl border border-gray-200 bg-white overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                    <h2 class="text-base font-semibold text-gray-900">Billing Details</h2>
                    {% if business.stripe_customer_id %}
                    <button @click="openPortal()" class="text-sm font-medium text-brand-600 hover:text-brand-700 transition">
                        Manage in Stripe &rarr;
                    </button>
                    {% endif %}
                </div>
                <div class="divide-y divide-gray-100">
                    <div class="flex items-center justify-between px-6 py-4">
                        <span class="text-sm text-gray-500">Account</span>
                        <span class="text-sm font-medium text-gray-900">{{ business.name }}</span>
                    </div>
                    <div class="flex items-center justify-between px-6 py-4">
                        <span class="text-sm text-gray-500">Email</span>
                        <span class="text-sm font-medium text-gray-900">{{ business.email }}</span>
                    </div>
                    <div class="flex items-center justify-between px-6 py-4">
                        <span class="text-sm text-gray-500">Plan</span>
                        <span class="text-sm font-medium text-gray-900">{{ plan_name }}</span>
                    </div>
                    <div class="flex items-center justify-between px-6 py-4">
                        <span class="text-sm text-gray-500">Monthly Rate</span>
                        <span class="text-sm font-medium text-gray-900">{{ plan_price }}</span>
                    </div>
                    <div class="flex items-center justify-between px-6 py-4">
                        <span class="text-sm text-gray-500">Setup Fee</span>
                        <span class="text-sm font-medium {{ 'text-green-600' if business.setup_fee_paid else 'text-gray-900' }}">
                            {{ 'Paid' if business.setup_fee_paid else '$3,000 (due on first payment)' }}
                        </span>
                    </div>
                    <div class="flex items-center justify-between px-6 py-4">
                        <span class="text-sm text-gray-500">Payment Method</span>
                        <span class="text-sm font-medium text-gray-900">
                            {% if business.stripe_customer_id %}
                            Stripe
                            {% else %}
                            <span class="text-gray-400">Not connected</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="flex items-center justify-between px-6 py-4">
                        <span class="text-sm text-gray-500">Member Since</span>
                        <span class="text-sm font-medium text-gray-900">{{ business.created_at|fmt_datetime }}</span>
                    </div>
                    <div class="flex items-center justify-between px-6 py-4">
                        <span class="text-sm text-gray-500">AI Phone Number</span>
                        <span class="text-sm font-medium text-gray-900">{{ business.assigned_phone_number or 'Not assigned' }}</span>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex items-center justify-between">
                    <p class="text-xs text-gray-400">Payments securely processed by <strong>Stripe</strong></p>
                    <svg class="h-6" viewBox="0 0 60 25" fill="none"><path d="M59.64 14.28c0-4.7-2.28-8.42-6.64-8.42-4.38 0-7.02 3.72-7.02 8.38 0 5.53 3.12 8.32 7.6 8.32 2.19 0 3.84-.5 5.09-1.19v-3.69c-1.25.63-2.69 1.01-4.51 1.01-1.79 0-3.37-.63-3.57-2.8h8.98c0-.24.07-1.18.07-1.61zm-9.08-1.75c0-2.08 1.27-2.95 2.43-2.95 1.13 0 2.33.87 2.33 2.95h-4.76zM38.28 5.86c-1.8 0-2.96.85-3.6 1.43l-.24-1.13h-4.04v21.38l4.59-.97.01-5.19c.66.47 1.62 1.14 3.22 1.14 3.25 0 6.22-2.62 6.22-8.39-.01-5.28-3.03-8.27-6.16-8.27zm-1.08 12.71c-1.07 0-1.7-.38-2.14-.85l-.02-6.73c.47-.53 1.13-.89 2.16-.89 1.65 0 2.79 1.85 2.79 4.23 0 2.43-1.12 4.24-2.79 4.24zM24.44 4.82l4.61-.99V.36l-4.61.98v3.48zM24.44 6.16h4.61v16.01h-4.61V6.16zM19.47 7.55l-.29-1.39h-3.97v16.01h4.59V11.1c1.09-1.42 2.93-1.15 3.5-.95V6.16c-.6-.22-2.76-.64-3.83 1.39zM10.36 2.07l-4.47.95-.02 14.65c0 2.7 2.03 4.69 4.73 4.69 1.5 0 2.59-.27 3.2-.6V18.1c-.58.24-3.45 1.07-3.45-1.62V9.82h3.45V6.16h-3.45l.01-4.09zM1.57 10.24c0-.6.5-.84 1.33-.84 1.19 0 2.69.36 3.88 1V6.56a10.33 10.33 0 00-3.88-.72C1.14 5.84 0 7.37 0 9.39c0 3.91 5.38 3.29 5.38 4.97 0 .71-.62.94-1.48.94-1.28 0-2.92-.53-4.22-1.24v3.87a10.72 10.72 0 004.22.88c1.85 0 4.14-.77 4.14-2.88-.01-4.22-5.47-3.47-5.47-5.05z" fill="#6772E5"/></svg>
                </div>
            </div>

        </div>
    </main>
</div>

<script>
function billingApp() {
    return {
        loading: false,
        selectedPlan: '',
        async subscribe(plan) {
            this.loading = true;
            this.selectedPlan = plan;
            try {
                const resp = await fetch('/api/stripe/checkout', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ plan }),
                });
                const data = await resp.json();
                if (data.checkout_url) {
                    window.location.href = data.checkout_url;
                } else {
                    alert(data.detail || 'Could not create checkout session');
                    this.loading = false;
                }
            } catch (e) {
                alert('Something went wrong. Please try again.');
                this.loading = false;
            }
        },
        async openPortal() {
            try {
                const resp = await fetch('/api/stripe/portal', { method: 'POST' });
                const data = await resp.json();
                if (data.portal_url) {
                    window.location.href = data.portal_url;
                } else {
                    alert(data.detail || 'Could not open billing portal');
                }
            } catch (e) {
                alert('Something went wrong. Please try again.');
            }
        }
    }
}
</script>
{% endblock %}
