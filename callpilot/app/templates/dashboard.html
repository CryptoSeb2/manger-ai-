{% extends "base.html" %}
{% block title %}Dashboard - WorkWithAi{% endblock %}

{% block body %}
<div class="flex h-full min-h-screen">
    {% include "nav.html" %}

    <main class="flex-1 overflow-y-auto">
        <div class="px-8 py-8">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-2xl font-bold text-gray-900">Welcome back, {{ business.name }}</h1>
                <p class="mt-1 text-sm text-gray-500">Here's what's happening with your AI phone agent.</p>
            </div>

            <!-- Phone number banner -->
            {% if business.assigned_phone_number %}
            <div class="mb-8 rounded-xl bg-brand-600 p-6 text-white shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-brand-100">Your AI Phone Number</p>
                        <p class="mt-1 text-3xl font-bold tracking-wide">{{ business.assigned_phone_number }}</p>
                        <p class="mt-2 text-sm text-brand-200">Forward your business calls here or share this number with customers.</p>
                    </div>
                    <div class="flex h-16 w-16 items-center justify-center rounded-2xl bg-white/10">
                        <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
                        </svg>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="mb-8 rounded-xl border-2 border-dashed border-gray-300 p-6 text-center" x-data="{ provisioning: false }">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
                </svg>
                <h3 class="mt-4 text-sm font-semibold text-gray-900">No AI agent provisioned yet</h3>
                <p class="mt-1 text-sm text-gray-500">Set up your Retell AI API key in your environment, then provision your agent.</p>
                <button @click="provisioning = true; fetch('/api/agent/provision', {method:'POST'}).then(r => r.json()).then(d => { if(d.phone_number) location.reload(); else alert(d.detail || 'Setup failed. Check your Retell API key.'); provisioning = false; }).catch(() => { provisioning = false; })"
                    :disabled="provisioning"
                    class="mt-4 inline-flex items-center rounded-lg bg-brand-600 px-4 py-2 text-sm font-semibold text-white hover:bg-brand-700 disabled:opacity-50">
                    <span x-show="!provisioning">Provision AI Agent</span>
                    <span x-show="provisioning" x-cloak>Setting up...</span>
                </button>
            </div>
            {% endif %}

            <!-- Stats -->
            <div class="mb-8 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
                <div class="rounded-xl bg-white p-6 shadow-sm border border-gray-200">
                    <div class="flex items-center gap-4">
                        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-blue-50">
                            <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 3.75v4.5m0-4.5h-4.5m4.5 0l-6 6m3 12c-8.284 0-15-6.716-15-15V4.5A2.25 2.25 0 014.5 2.25h1.372c.516 0 .966.351 1.091.852l1.106 4.423c.11.44-.055.902-.417 1.173l-1.293.97a1.062 1.062 0 00-.38 1.21 12.035 12.035 0 007.143 7.143c.441.162.928-.004 1.21-.38l.97-1.293a1.125 1.125 0 011.173-.417l4.423 1.106c.5.125.852.575.852 1.091V19.5a2.25 2.25 0 01-2.25 2.25h-2.25z" />
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Calls</p>
                            <p class="text-2xl font-bold text-gray-900">{{ total_calls }}</p>
                        </div>
                    </div>
                </div>

                <div class="rounded-xl bg-white p-6 shadow-sm border border-gray-200">
                    <div class="flex items-center gap-4">
                        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-green-50">
                            <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Appointments</p>
                            <p class="text-2xl font-bold text-gray-900">{{ total_appointments }}</p>
                        </div>
                    </div>
                </div>

                <div class="rounded-xl bg-white p-6 shadow-sm border border-gray-200">
                    <div class="flex items-center gap-4">
                        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-purple-50">
                            <svg class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 00-2.455 2.456z" />
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">AI Status</p>
                            <p class="text-2xl font-bold {{ 'text-green-600' if business.retell_agent_id else 'text-gray-400' }}">
                                {{ 'Active' if business.retell_agent_id else 'Inactive' }}
                            </p>
                        </div>
                    </div>
                </div>

                <div class="rounded-xl bg-white p-6 shadow-sm border border-gray-200">
                    <div class="flex items-center gap-4">
                        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-amber-50">
                            <svg class="h-6 w-6 text-amber-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Upcoming</p>
                            <p class="text-2xl font-bold text-gray-900">{{ upcoming_appointments|length }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Two columns: Recent Calls + Upcoming Appointments -->
            <div class="grid grid-cols-1 gap-8 lg:grid-cols-2">
                <!-- Recent Calls -->
                <div class="rounded-xl bg-white shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between border-b border-gray-100 px-6 py-4">
                        <h2 class="text-base font-semibold text-gray-900">Recent Calls</h2>
                        <a href="/calls" class="text-sm font-medium text-brand-600 hover:text-brand-500">View all</a>
                    </div>
                    <div class="divide-y divide-gray-100">
                        {% if recent_calls %}
                            {% for call in recent_calls %}
                            <div class="flex items-center gap-4 px-6 py-4">
                                <div class="flex h-10 w-10 items-center justify-center rounded-full {{ 'bg-green-50' if call.sentiment == 'positive' else ('bg-red-50' if call.sentiment == 'negative' else 'bg-gray-50') }}">
                                    <svg class="h-5 w-5 {{ 'text-green-600' if call.sentiment == 'positive' else ('text-red-600' if call.sentiment == 'negative' else 'text-gray-400') }}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900">{{ call.caller_number or 'Unknown caller' }}</p>
                                    <p class="truncate text-sm text-gray-500">{{ call.summary or 'No summary available' }}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-500">{{ call.created_at|fmt_datetime }}</p>
                                    <p class="text-xs text-gray-400">{{ call.duration_seconds|duration }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="px-6 py-12 text-center">
                                <p class="text-sm text-gray-500">No calls yet. Your AI agent is ready and waiting!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Upcoming Appointments -->
                <div class="rounded-xl bg-white shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between border-b border-gray-100 px-6 py-4">
                        <h2 class="text-base font-semibold text-gray-900">Upcoming Appointments</h2>
                        <a href="/appointments" class="text-sm font-medium text-brand-600 hover:text-brand-500">View all</a>
                    </div>
                    <div class="divide-y divide-gray-100">
                        {% if upcoming_appointments %}
                            {% for appt in upcoming_appointments %}
                            <div class="flex items-center gap-4 px-6 py-4">
                                <div class="flex h-10 w-10 items-center justify-center rounded-full bg-brand-50">
                                    <svg class="h-5 w-5 text-brand-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900">{{ appt.customer_name }}</p>
                                    <p class="text-sm text-gray-500">{{ appt.service or 'General' }}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs font-medium text-gray-900">{{ appt.appointment_time|fmt_datetime }}</p>
                                    <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium {{ 'bg-green-50 text-green-700' if appt.status == 'confirmed' else 'bg-gray-50 text-gray-600' }}">
                                        {{ appt.status|capitalize }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="px-6 py-12 text-center">
                                <p class="text-sm text-gray-500">No upcoming appointments.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}
